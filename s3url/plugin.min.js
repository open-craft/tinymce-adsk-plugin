tinymce.PluginManager.add("s3url",function(t){function e(e){var a=t.selection.getContent();if(/</.test(a)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(a)||-1==a.indexOf("href=")))return!1;if(e){var n,l=e.childNodes;if(0===l.length)return!1;for(n=l.length-1;n>=0;n--)if(3!=l[n].nodeType)return!1}return!0}function a(t){var e=/(https:\/\/)?(s3-|s3\.)?(.*)\.amazonaws\.com(.*)/;return e.test(t)?!0:!1}var n=function(){return selectedElm=t.selection.getNode(),anchorElm=t.dom.getParent(selectedElm,"a[href]"),onlyText=e(),t.windowManager.open({title:"S3 Link",data:{text:initialText=anchorElm?anchorElm.innerText||anchorElm.textContent:t.selection.getContent({format:"text"}),href:anchorElm?t.dom.getAttrib(anchorElm,"href"):"",target:anchorElm?t.dom.getAttrib(anchorElm,"target"):t.settings.default_link_target||null,title:anchorElm?t.dom.getAttrib(anchorElm,"title"):""},body:[{name:"href",type:"filepicker",filetype:"file",size:40,autofocus:!0,label:"Url"},{name:"text",type:"textbox",size:40,label:"Text to display",onchange:function(){data.text=this.value()}},{type:"listbox",name:"linktype",label:"Link Type",values:[{text:"Download",value:"download"},{text:"Offer",value:"offer"}]},{type:"listbox",name:"filetype",label:"File Type",values:[{text:"Document/PDF",value:"pdf"},{text:"Video",value:"video"},{text:"Audesk design files",value:"design"}]},{type:"listbox",name:"orientation",label:"Display Orientation",values:[{text:"Vertical",value:"vertical"},{text:"Horizontal",value:"horizontal"}]},{type:"listbox",name:"class",label:"Visual style",values:[{text:"Primary",value:"btn-primary"},{text:"Normal",value:"btn"},{text:"Secondary",value:"btn-secondary"}]}],onsubmit:function(e){function n(){var n={href:e.data.href,target:e.data.target?e.data.target:null,rel:e.data.rel?e.data.rel:null,"class":e.data.class?e.data.class:null,title:e.data.title?e.data.title:null,"data-wat-linkname":e.data.text,"data-wat-link":!0,"pagefile-type":e.data.filetype,orientation:e.data.orientation},l=e.data.href.split("/"),o=l[l.length-1].split(".")[0];return"download"==e.data.linktype&&(n.download=o),a(e.data.href)?void(anchorElm?(t.focus(),onlyText&&e.data.text!=initialText&&("innerText"in anchorElm?anchorElm.innerText=e.data.text:anchorElm.textContent=e.data.text),t.dom.setAttribs(anchorElm,n),t.selection.select(anchorElm),t.undoManager.add()):onlyText?t.insertContent(t.dom.createHTML("a",n,t.dom.encode(e.data.text))):t.execCommand("mceInsertLink",!1,n)):void t.execCommand("unlink")}n()}})};t.addButton("s3url",{icon:!1,text:"S3 Link",stateSelector:"a[href]",onclick:n}),t.addMenuItem("s3url",{icon:!1,text:"S3 Link",stateSelector:"a[href]",onclick:n})});