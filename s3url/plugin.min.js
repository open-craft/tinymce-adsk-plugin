tinymce.PluginManager.add("s3url",function(t,e){function n(e){var n=t.selection.getContent();if(/</.test(n)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(n)||-1==n.indexOf("href=")))return!1;if(e){var a,l=e.childNodes;if(0===l.length)return!1;for(a=l.length-1;a>=0;a--)if(3!=l[a].nodeType)return!1}return!0}function a(t){var e=/(https:\/\/)?(s3-|s3\.)?(.*)\.amazonaws\.com(.*)/;return e.test(t)?!0:!1}tinymce.DOM.loadCSS(e+"/css/s3url.css");var l=function(){var e=[{text:"- Select a link type -",value:null}];return tinymce.each(t.settings.s3url.linktypes,function(t){e.push({text:t,value:t.toLowerCase()})}),e},o=function(){var e=[{text:"- Select a file type -",value:null}];return tinymce.each(t.settings.s3url.filetypes,function(t){e.push({text:t,value:t.toLowerCase()})}),e},i=function(){var e=[{text:"- Select orientation -",value:null}];return tinymce.each(t.settings.s3url.orientations,function(t){e.push({text:t,value:t.toLowerCase()})}),e},r=function(){var e=[{text:"- Select a visual style -",value:null}];return tinymce.each(t.settings.s3url.styles,function(t){e.push({text:t,value:"mce-adsk-btn-"+t.toLowerCase()})}),e},s=function(){return selectedElm=t.selection.getNode(),anchorElm=t.dom.getParent(selectedElm,"a[href]"),onlyText=n(),t.windowManager.open({title:"S3 Link",data:{text:initialText=anchorElm?anchorElm.innerText||anchorElm.textContent:t.selection.getContent({format:"text"}),href:anchorElm?t.dom.getAttrib(anchorElm,"href"):"",target:anchorElm?t.dom.getAttrib(anchorElm,"target"):t.settings.default_link_target||null,title:anchorElm?t.dom.getAttrib(anchorElm,"title"):""},body:[{name:"href",type:"filepicker",filetype:"file",size:40,autofocus:!0,label:"Url"},{name:"text",type:"textbox",size:40,label:"Text to display",onchange:function(){data.text=this.value()}},{type:"listbox",name:"linktype",label:"Link Type",values:l(),value:anchorElm?t.dom.getAttrib(anchorElm,"download")?"download":"offer":null},{type:"listbox",name:"filetype",label:"File Type",values:o(),value:anchorElm?t.dom.getAttrib(anchorElm,"pagefile-type"):null},{type:"listbox",name:"orientation",label:"Display Orientation",values:i(),value:anchorElm?t.dom.getAttrib(anchorElm,"orientation"):null},{type:"listbox",name:"class",label:"Visual style",values:r(),value:anchorElm?t.dom.getAttrib(anchorElm,"class"):null}],onsubmit:function(e){function n(){var n={href:e.data.href,target:e.data.target?e.data.target:null,rel:e.data.rel?e.data.rel:null,"class":e.data.class?e.data.class:null,title:e.data.title?e.data.title:null,"data-wat-linkname":e.data.text,"data-wat-link":!0,"pagefile-type":e.data.filetype,orientation:e.data.orientation},l=e.data.href.split("/"),o=l[l.length-1].split(".")[0];return n.download="download"==e.data.linktype?o:null,a(e.data.href)?void(anchorElm?(t.focus(),onlyText&&e.data.text!=initialText&&("innerText"in anchorElm?anchorElm.innerText=e.data.text:anchorElm.textContent=e.data.text),t.dom.setAttribs(anchorElm,n),t.selection.select(anchorElm),t.undoManager.add()):onlyText?t.insertContent(t.dom.createHTML("a",n,t.dom.encode(e.data.text))):t.execCommand("mceInsertLink",!1,n)):void t.execCommand("unlink")}n()}})};t.addButton("s3url",{icon:!1,text:"S3 Link",stateSelector:"a[href]",onclick:s}),t.addMenuItem("s3url",{icon:!1,text:"S3 Link",stateSelector:"a[href]",onclick:s})});