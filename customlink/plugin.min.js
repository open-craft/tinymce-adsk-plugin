tinymce.PluginManager.add("customlink",function(t,e){function a(e){var a=t.selection.getContent();if(/</.test(a)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(a)||-1==a.indexOf("href=")))return!1;if(e){var n,l=e.childNodes;if(0===l.length)return!1;for(n=l.length-1;n>=0;n--)if(3!=l[n].nodeType)return!1}return!0}tinymce.DOM.loadCSS(e+"/css/customlink.css");var n=function(){var e=[{text:"- Select a link type -",value:null}];return tinymce.each(t.settings.custom.linktypes,function(t){e.push({text:t,value:t.toLowerCase()})}),e},l=function(){var e=[{text:"- Select a file type -",value:null}];return tinymce.each(t.settings.custom.filetypes,function(t){e.push({text:t,value:t.toLowerCase()})}),e},i=function(){var e=[{text:"- Select orientation -",value:null}];return tinymce.each(t.settings.custom.orientations,function(t){e.push({text:t,value:t.toLowerCase()})}),e},o=function(){var e=[{text:"- Select a visual style -",value:null}];return tinymce.each(t.settings.custom.styles,function(t){e.push({text:t,value:"mce-custom-btn-"+t.toLowerCase()})}),e},r=function(){return selectedElm=t.selection.getNode(),anchorElm=t.dom.getParent(selectedElm,"a[href]"),onlyText=a(),t.windowManager.open({title:"Custom Link",data:{text:initialText=anchorElm?anchorElm.innerText||anchorElm.textContent:t.selection.getContent({format:"text"}),href:anchorElm?t.dom.getAttrib(anchorElm,"href"):"",target:anchorElm?t.dom.getAttrib(anchorElm,"target"):t.settings.default_link_target||null,title:anchorElm?t.dom.getAttrib(anchorElm,"title"):""},body:[{name:"href",type:"filepicker",filetype:"file",size:40,autofocus:!0,label:"Url"},{name:"text",type:"textbox",size:40,label:"Text to display",onchange:function(){data.text=this.value()}},{type:"listbox",name:"linktype",label:"Link Type",values:n(),value:anchorElm?t.dom.getAttrib(anchorElm,"download")?"download":"offer":null},{type:"listbox",name:"filetype",label:"File Type",values:l(),value:anchorElm?t.dom.getAttrib(anchorElm,"pagefile-type"):null},{type:"listbox",name:"orientation",label:"Display Orientation",values:i(),value:anchorElm?t.dom.getAttrib(anchorElm,"orientation"):null},{type:"listbox",name:"class",label:"Visual style",values:o(),value:anchorElm?t.dom.getAttrib(anchorElm,"class"):null}],onsubmit:function(e){function a(){var a={href:e.data.href,target:e.data.target?e.data.target:null,rel:e.data.rel?e.data.rel:null,"class":e.data.class?e.data.class:null,title:e.data.title?e.data.title:null,"data-wat-linkname":e.data.text,"data-wat-link":!0,"pagefile-type":e.data.filetype,orientation:e.data.orientation},n=e.data.href.split("/"),l=n[n.length-1].split(".")[0];return a.download="download"==e.data.linktype?l:null,e.data.href?void(anchorElm?(t.focus(),onlyText&&e.data.text!=initialText&&("innerText"in anchorElm?anchorElm.innerText=e.data.text:anchorElm.textContent=e.data.text),t.dom.setAttribs(anchorElm,a),t.selection.select(anchorElm),t.undoManager.add()):onlyText?t.insertContent(t.dom.createHTML("a",a,t.dom.encode(e.data.text))):t.execCommand("mceInsertLink",!1,a)):void t.execCommand("unlink")}a()}})};t.addButton("customlink",{icon:!1,text:"Custom Link",stateSelector:"a[href]",onclick:r}),t.addMenuItem("customlink",{icon:!1,text:"Custom Link",stateSelector:"a[href]",onclick:r})});